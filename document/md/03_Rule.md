# 採点とレギュレーション

## 採点方法について

チューニング結果を各チームの VM に反映し、[評価スクリプト](./99_manual.md#%e8%a9%95%e4%be%a1%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88)をそれぞれの VM 内で実行することで採点ができます。

評価スクリプトでは、以下のプロセスで評価を行います。

- Step1. データベースを初期状態に戻す (顧客データをセット)
- Step2. 簡易 DB マイグレーションの実行
- Step3. API 動作テスト (e2e テスト)の実施
- Step4. 負荷試験の実施
- Step5. スコアの計算
- Step6. スコアの表示 & 運営への送信

Step3 では[API 仕様書](../openapi/openapi.yaml)をベースに、主要な要件を満たしているかをチェックします。問題があった場合はそこで採点が停止します。

Step4 では一定時間各 API に対して多数のリクエストを行います。

Step5 では Step4 で処理できたリクエスト数をベースにスコアが計算されます。

Step6 で画面に表示されたスコアが、その時点のチームの持ち点になります。

\*スコア上位グループについては、成果物に対して追加で審議される場合があります。

## レギュレーション

「本番稼働開始済みの業務アプリケーション」に対するパフォーマンス改善を行うことが原則です。

以下の行為は減点、0 点、あるいは失格の対象となる場合があります。

- 原則を大きく逸脱した、極端な最適化を行うこと
  - API 動作テストは PASS するが、業務アプリとして実質使えなくなるような最適化は NG です。
  - 微妙なラインの場合は、審議する場合があります。
- 初期データ (顧客データ)を欠損させる最適化
  - データを消して高速化するなど。顧客データは API を通して引き続き利用できなければいけません。
  - 既存テーブル・カラム名の変更・削除は行わないでください。
  - 改善の過程で、検証のためにデータを変更したり削除してみる行為は問題ありません
- UI が明らかに変わるような仕様変更
- [マニュアル](./99_manual.md#%E7%92%B0%E5%A2%83%E3%81%AE%E5%88%B6%E7%B4%84%E4%BA%8B%E9%A0%85)に記載された、環境の制約事項を利用する最適化
- 採点中に提供された環境以外のリソースを利用し、処理能力を上げること (例: 個人 PC でリクエスト処理を代替する)
- 採点モジュールの改ざん、または不具合を悪用し不当にスコアを上げること
- 他チームの環境にログインし、コードを変更したり DOS 攻撃等の妨害行為を行うこと
- 他チームと結託すること。他チームの環境にログインする、リポジトリを見るなどのカンニング行為
- その他、主催者側が不適切と判断した行為

「これは OK?」と思った時は、[マニュアル](./99_manual.md)を参照してください。

## 評価スクリプトの動作詳細

### Step4 の補足

Step4 では、負荷試験ツール「k6」を用いて、{環境 ID}.ftt2306.dabaas.net に対して HTTPS 接続で下記の手順で負荷試験を実施します。

1. 試験開始後 60 秒かけて徐々に接続が確立、ピーク時には各 API 毎に 120 接続が確立され、それぞれの接続から API が呼び出されます。
2. 1 接続では特定の API に対しリクエストを行い、レスポンスを受け取った後再びリクエストを行う、という動作を繰り返します。リクエストのタイムアウト時間は 50 秒です。
3. 負荷試験開始後 60 秒が経過した時点でレスポンスを待っているリクエストについては、そこからさらに最大 60 秒間レスポンスの返却を待機します。ただし、上述したタイムアウト時間 50 秒を超えてレスポンスを待つことはありません。

それぞれの API は Step4 実施中、同時にテストがされていることに注意してください。一つ一つの API を順番にテストしているわけではありません。

### Step5 の補足

Step5 では、さらに以下のステップでスコアが求められます。

- Step5-1. Step4.の結果から、各 API の成功応答回数と\*失敗応答回数を求める
- Step5-2. それぞれの API について、下記に定めた補正係数を成功応答回数にかけた点数を基本点とする
- Step5-3. 5-2.の基本点に対し、5-1. で求めた失敗応答回数 x **20 点**を減点し、\*最終スコアを計算する

\* 失敗とは、API 仕様書に定められた成功時以外のステータスコードが返ったリクエストのことを指します

\* ただし、本競技ではタイムアウトとなったリクエストは失敗として扱いません

\* 最終スコアが 0 点を下回った場合、0 点として扱います

補正係数:

| API                                | score |
| ---------------------------------- | ----- |
| POST /session                      | 10.0  |
| GET /users/user-icon/{userIconId}  | 1.0   |
| GET /users                         | 1.0   |
| GET /users/search                  | 1.0   |
| POST /match-groups                 | 10.0  |
| GET /match-groups/members/{userId} | 1.0   |
